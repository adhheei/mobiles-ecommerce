<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <script src="/js/authGuard.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thank You - Jinsa Mobiles</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #fcfcfc;
        color: #1a1a1a;
      }

      .thank-you-container {
        max-width: 800px;
        margin: 60px auto;
        text-align: center;
        padding: 0 15px;
      }

      /* Added Animation */
      .reveal-up-element {
        opacity: 0;
        transform: translateY(40px);
        transition:
          opacity 0.8s ease-out,
          transform 0.8s ease-out;
      }

      .reveal-up-element.active {
        opacity: 1;
        transform: translateY(0);
      }

      /* Homepage Title Font Style */
      h1.homepage-font {
        font-family: "Poppins", sans-serif;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .success-icon {
        width: 80px;
        height: 80px;
        background-color: #28a745;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin: 0 auto 25px;
      }

      .order-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        text-align: left;
      }

      .order-card-header {
        padding: 20px 30px;
        border-bottom: 1px solid #eee;
      }

      .order-item-row {
        padding: 20px 30px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #eee;
      }

      .item-thumb {
        width: 60px;
        height: 70px;
        border-radius: 8px;
        object-fit: cover;
        margin-right: 20px;
      }

      .item-total {
        margin-left: auto;
        font-weight: 600;
      }

      .order-totals-row {
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
      }

      .order-totals-row.final {
        font-size: 1.1rem;
        font-weight: 700;
        border-top: 1px solid #eee;
      }

      .size-lg {
        font-size: 1.2rem;
        font-weight: 800;
      }

      .shipping-info-row {
        padding: 20px 30px;
        background: #f9f9f9;
        display: flex;
        justify-content: space-between;
        gap: 30px;
      }

      .action-buttons {
        margin-top: 40px;
        display: flex;
        justify-content: center;
        gap: 20px;
      }

      .btn-black {
        background: #1a1a1a;
        color: white;
        padding: 12px 30px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
      }

      .btn-outline {
        background: #e9ecef;
        padding: 12px 30px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        color: #1a1a1a;
      }
    </style>
  </head>

  <body>
    <div class="thank-you-container reveal-up-element">
      <div class="success-icon">
        <i class="fa-solid fa-check"></i>
      </div>

      <h1 class="homepage-font display-5 mb-3">Thank You for Your Order!</h1>
      <p class="order-number-text text-muted mb-4"></p>

      <div class="mb-4">
        <span
          class="badge bg-success fs-6 px-3 py-2 rounded-pill"
          id="order-status-badge"
          >Order Placed Successfully</span
        >
      </div>

      <div class="order-card">
        <div class="order-card-header">
          <h5>Order Summary</h5>
          <p class="text-muted">A confirmation email has been sent.</p>
        </div>

        <!-- Items inserted dynamically -->

        <!-- Totals inserted dynamically -->

        <div class="shipping-info-row">
          <div class="info-column">
            <h6>Shipping Address</h6>
            <p></p>
          </div>
          <div class="info-column text-end">
            <h6>Estimated Delivery</h6>
            <p></p>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <a href="./userOrderDetails.html" class="btn-black"
          >View Order History</a
        >
        <a href="/User/index.html" class="btn-outline">Continue Shopping</a>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ✅ FINAL FIXED SCRIPT -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const summaryJSON = sessionStorage.getItem("lastOrderData");

        if (!summaryJSON) {
          return;
        }

        const order = JSON.parse(summaryJSON);

        // --- 1. IMAGE HELPER FUNCTION ---
        // Essential for fixing "ERR_NAME_NOT_RESOLVED" and "404 Not Found"
        function formatImageUrl(path) {
          if (!path) return "https://placehold.co/100x100?text=No+Image";

          // If it's already a full external URL, return it
          if (path.startsWith("http")) return path;

          // Normalize Windows backslashes and remove 'public/' prefix
          let cleanPath = path.replace(/^public\//, "").replace(/\\/g, "/");

          // Ensure the path starts with a leading slash for root-relative loading
          if (!cleanPath.startsWith("/")) {
            cleanPath = "/" + cleanPath;
          }
          return cleanPath;
        }

        // Fix: Add ID to View Order button
        const detailsBtn = document.querySelector(".action-buttons .btn-black");
        if (detailsBtn && order.dbOrderId) {
          detailsBtn.href = `./userOrderDetails.html?id=${order.dbOrderId}`;
          detailsBtn.innerText = "View Order Details";
        }

        const container = document.querySelector(".thank-you-container");
        // Trigger animation after render
        setTimeout(() => {
          if (container) container.classList.add("active");
        }, 100);

        /* Order ID & Date */
        const orderNumEl = document.querySelector(".order-number-text");
        if (orderNumEl) {
          orderNumEl.innerHTML = `Your order <strong>#${order.orderId}</strong> has been placed.<br>
         <small class="text-muted">${new Date().toLocaleDateString("en-IN", { weekday: "long", year: "numeric", month: "long", day: "numeric" })}</small>`;
        }

        // Add Payment Method Badge
        const statusBadge = document.getElementById("order-status-badge");
        if (statusBadge && order.paymentMethod) {
          statusBadge.innerText = `Order Placed • ${order.paymentMethod}`;
        }

        /* --- 2. RENDER ITEMS --- */
        const card = document.querySelector(".order-card");
        const header = document.querySelector(".order-card-header");

        // Clear existing items if any
        document.querySelectorAll(".order-item-row").forEach((e) => e.remove());

        if (order.items && header) {
          order.items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "order-item-row";

            // Handle price display
            let priceHtml = "";
            const mrp = item.mrp || item.price;
            const price = item.price;

            if (mrp > price) {
              priceHtml = `
              <del class="text-muted small me-2">Rs. ${mrp}</del>
              <span class="text-success fw-bold">Rs. ${price}</span>
            `;
            } else {
              priceHtml = `<span class="fw-bold">Rs. ${price}</span>`;
            }

            // Apply the fixed image URL helper
            const imageSrc = formatImageUrl(item.image);

            row.innerHTML = `
          <img src="${imageSrc}" 
               alt="${item.name}" 
               class="item-thumb"
               style="width: 50px; height: 60px; object-fit: contain;"
               onerror="this.src='https://placehold.co/50x60?text=Error'">
          <div style="flex-grow: 1;">
            <div class="fw-bold mb-1">${item.name}</div>
            <div class="text-muted small">Qty: ${item.quantity}</div>
            <div class="mt-1">${priceHtml}</div>
          </div>
          <div class="item-total fw-bold">Rs. ${item.price * item.quantity}</div>
        `;

            header.after(row);
          });
        }

        /* --- 3. TOTALS --- */
        const shippingRow = document.querySelector(".shipping-info-row");
        // Remove existing totals to prevent duplicates
        document
          .querySelectorAll(".order-totals-row")
          .forEach((e) => e.remove());

        const addTotal = (label, value, colorClass = "", bold = false) => {
          const row = document.createElement("div");
          row.className = `order-totals-row ${bold ? "final" : ""}`;
          row.innerHTML = `
      <span class="${bold ? "" : "text-muted"}">${label}</span>
      <span class="${colorClass} ${bold ? "fw-bold" : ""}">
        ${typeof value === "number" ? `Rs. ${value.toLocaleString("en-IN")}` : value}
      </span>`;
          if (card && shippingRow) {
            card.insertBefore(row, shippingRow); // Insert *before* shipping info
          }
        };

        if (order.totals) {
          // 1. Actual Price (Total MRP)
          if (order.totals.totalMrp) {
            addTotal("Actual Price", order.totals.totalMrp);
          }

          // 2. Offer Price (Subtotal)
          if (
            order.totals.totalMrp &&
            order.totals.subtotal &&
            order.totals.totalMrp > order.totals.subtotal
          ) {
            addTotal("Offer Price", order.totals.subtotal);
            const savings = order.totals.totalMrp - order.totals.subtotal;
            addTotal("Savings", `- Rs. ${savings}`, "text-success");
          } else if (!order.totals.totalMrp && order.totals.subtotal) {
            addTotal("Price", order.totals.subtotal);
          }

          // 3. Coupon Discount
          if (order.totals.couponDiscount && order.totals.couponDiscount > 0) {
            addTotal(
              "Coupon Discount",
              `- Rs. ${order.totals.couponDiscount}`,
              "text-success",
            );
          }

          // 4. Wallet
          if (order.totals.walletDeducted && order.totals.walletDeducted > 0) {
            addTotal(
              "Wallet Paid",
              `- Rs. ${order.totals.walletDeducted}`,
              "text-success",
            );
          }

          // 5. Shipping
          const shippingCost =
            order.totals.shipping === 0 ? "Free" : order.totals.shipping;
          const shippingColor =
            order.totals.shipping === 0 ? "text-success fw-bold" : "";
          addTotal("Shipping", shippingCost, shippingColor);

          // 6. Total Payable Amount
          addTotal(
            "Total Payable Amount",
            order.totals.totalAmount,
            "size-lg",
            true,
          );
        }

        /* --- 4. ESTIMATED DELIVERY --- */
        const start = new Date();
        start.setDate(start.getDate() + 6);
        const end = new Date();
        end.setDate(end.getDate() + 7);

        const format = (d) =>
          d.toLocaleDateString("en-IN", {
            weekday: "short",
            day: "numeric",
            month: "short",
          });

        const deliveryEl = document.querySelector(
          ".shipping-info-row .info-column:last-child p",
        );
        if (deliveryEl) {
          deliveryEl.innerHTML = `<span class="fw-bold text-success">${format(start)} – ${format(end)}</span>`;
        }

        /* --- 5. ADDRESS --- */
        const a = order.address;
        const addrEl = document.querySelector(
          ".shipping-info-row .info-column p",
        );
        if (a && addrEl) {
          addrEl.innerHTML = `
          <div class="fw-bold text-dark">${a.fullName}</div>
          <div class="text-muted small">
              ${a.street}<br>
              ${a.city}, ${a.state} - ${a.pincode}<br>
              Phone: ${a.phone}
          </div>
      `;
        }

        // Optional cleanup
        // sessionStorage.removeItem("lastOrderData");
      });
    </script>
  </body>
</html>
