<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messages - Jinsa Mobiles Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary-black: #1a1a1a;
      --bg-light: #f8f9fa;
      --border-color: #eee;
      --sidebar-width: 260px;
      --active-bg: #e9ecef;
      --text-muted: #6c757d;
      --unread-bg: #f0f7ff;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: var(--bg-light);
      overflow-x: hidden;
      color: var(--primary-black);
    }

    /* --- ANIMATIONS --- */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .content-animate {
      animation: slideInUp 0.6s ease-out forwards;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: var(--sidebar-width);
      height: 100vh;
      background-color: #fff;
      border-right: 1px solid var(--border-color);
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      padding: 20px;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .brand-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 40px;
      text-decoration: none;
      color: var(--primary-black);
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .brand-text-container {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }

    .brand-title {
      font-weight: 800;
      font-size: 1rem;
      color: #000;
    }

    .brand-subtitle {
      font-size: 0.55rem;
      letter-spacing: 2px;
      color: #777;
      font-weight: 600;
      text-transform: uppercase;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
    }

    .menu-item {
      margin-bottom: 5px;
    }

    .menu-link {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #555;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .menu-link i {
      width: 25px;
      font-size: 1.1rem;
      color: #777;
    }

    .menu-link:hover {
      background-color: var(--bg-light);
      color: #000;
    }

    .menu-link.active {
      background-color: var(--active-bg);
      color: #000;
      font-weight: 600;
    }

    .menu-link.active i {
      color: #000;
    }

    .admin-profile {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .profile-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      text-decoration: none;
      color: inherit;
    }

    .admin-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #ccc;
    }

    .admin-details h6 {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .admin-details span {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .logout-btn {
      width: 100%;
      background-color: var(--bg-light);
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: 0.2s;
      text-decoration: none;
    }

    .logout-btn:hover {
      background-color: #e2e6ea;
      color: #000;
    }

    /* --- MAIN CONTENT --- */
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 30px;
      transition: margin-left 0.3s ease;
    }

    /* Mobile Nav */
    .mobile-nav {
      display: none;
      background: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .mobile-nav .brand-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 0;
      text-decoration: none;
      color: var(--primary-black);
    }

    .brand-text-mobile {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
      text-align: left;
    }

    .brand-title-mobile {
      font-weight: 800;
      font-size: 1rem;
      color: #000;
      display: block;
    }

    .brand-subtitle-mobile {
      font-size: 0.6rem;
      letter-spacing: 1px;
      color: #777;
      font-weight: 600;
      text-transform: uppercase;
      display: block;
    }

    /* Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 1.8rem;
      font-weight: 800;
      margin: 0;
      color: #000;
    }

    /* Toolbar */
    .toolbar-container {
      background: #fff;
      padding: 25px;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }

    .search-box {
      position: relative;
      flex-grow: 1;
      max-width: 400px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border-radius: 12px;
      border: 1px solid #eee;
      background-color: #fcfcfc;
      font-size: 0.88rem;
      font-family: "Poppins", sans-serif;
    }

    .search-box i {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: #aaa;
    }

    .filter-select {
      border-radius: 12px;
      border: 1px solid #eee;
      padding: 8px 35px 8px 18px;
      font-size: 0.85rem;
      font-weight: 500;
      height: 46px;
      appearance: none;
      background: #fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") no-repeat right 0.75rem center/16px 12px;
      font-family: "Poppins", sans-serif;
      min-width: 160px;
    }

    /* Message List */
    .message-list {
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      margin-bottom: 25px;
    }

    .message-item {
      display: flex;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid #f9f9f9;
      cursor: pointer;
      transition: 0.2s;
      position: relative;
    }

    .message-item:last-child {
      border-bottom: none;
    }

    .message-item:hover {
      background-color: #fafafa;
    }

    .message-item.unread {
      background-color: var(--unread-bg);
    }

    .message-item.unread::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background-color: #0d6efd;
    }

    .message-item.replied::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background-color: #198754;
      /* Bootstrap success green */
    }

    .msg-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #475569;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .msg-content {
      flex-grow: 1;
      min-width: 0;
      margin-right: 15px;
    }

    .msg-sender {
      font-weight: 600;
      font-size: 0.95rem;
      color: #000;
    }

    .msg-time {
      font-size: 0.75rem;
      color: #888;
      white-space: nowrap;
    }

    .msg-subject {
      font-weight: 500;
      font-size: 0.9rem;
      color: #333;
      display: block;
      margin-top: 4px;
    }

    .msg-preview {
      font-size: 0.85rem;
      color: #777;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      margin-top: 4px;
    }

    .msg-actions {
      display: flex;
      gap: 10px;
      opacity: 0;
      transition: 0.2s;
    }

    .message-item:hover .msg-actions {
      opacity: 1;
    }

    .action-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #eee;
      color: #555;
      background: #fff;
      text-decoration: none;
    }

    .action-icon:hover {
      background: #f8f9fa;
      color: #000;
      border-color: #ccc;
    }

    .action-icon.delete:hover {
      background: #ffe5e5;
      color: #dc3545;
      border-color: #f5c2c7;
    }

    /* Modal Styling */
    .modal-content {
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .modal-header {
      padding: 25px 25px 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-body {
      padding: 25px;
    }

    .modal-footer {
      padding: 15px 25px 25px;
      border-top: 1px solid var(--border-color);
    }

    .detail-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
    }

    .message-body-text {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #333;
    }

    @media (max-width: 991px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.active {
        transform: translateX(0);
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
      }

      .main-content {
        margin-left: 0;
        padding: 20px;
      }

      .mobile-nav {
        display: flex;
      }

      .toolbar-container {
        flex-direction: column;
        align-items: stretch;
        padding: 20px;
      }

      .search-box {
        max-width: 100%;
      }

      .filter-select {
        width: 100%;
      }

      .msg-actions {
        opacity: 1;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 998;
      }

      .sidebar-overlay.active {
        display: block;
      }
    }
  </style>
</head>

<body>
  <div class="mobile-nav">
    <a href="#" class="brand-section">
      <img src="../../images/logo.jpg" alt="Logo" class="brand-logo" />
      <div class="brand-text-mobile">
        <span class="brand-title-mobile">JINSA MOBILES</span>
        <span class="brand-subtitle-mobile">AND ACCESSORIES</span>
      </div>
    </a>
    <button class="btn btn-light" onclick="toggleSidebar()">
      <i class="fa-solid fa-bars"></i>
    </button>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <nav class="sidebar" id="sidebar">
    <a href="./adminDashboard.html" class="brand-section">
      <img src="../../images/logo.jpg" alt="Logo" class="brand-logo" />
      <div class="brand-text-container">
        <span class="brand-title">JINSA MOBILES</span>
        <span class="brand-subtitle">AND ACCESSORIES</span>
      </div>
    </a>

    <ul class="sidebar-menu">
      <li class="menu-item"><a href="../Admin/adminDashboard.html" class="menu-link"><i
            class="fa-solid fa-border-all"></i> &nbsp;Dashboard</a></li>
      <li class="menu-item"><a href="../Admin/adminOrders.html" class="menu-link"><i
            class="fa-solid fa-cart-shopping"></i> &nbsp;Orders</a></li>
      <li class="menu-item"><a href="../Admin/adminProducts.html" class="menu-link"><i class="fa-solid fa-box-open"></i>
          &nbsp;Products</a></li>
      <li class="menu-item"><a href="../Admin/adminCustomers.html" class="menu-link"><i class="fa-solid fa-users"></i>
          &nbsp;Customers</a></li>
      <li class="menu-item"><a href="../Admin/adminMessages.html" class="menu-link active"><i
            class="fa-regular fa-envelope"></i> &nbsp;Messages</a></li>
      <li class="menu-item"><a href="../Admin/adminAnalytics.html" class="menu-link"><i
            class="fa-solid fa-chart-simple"></i> &nbsp;Analytics</a></li>
      <li class="menu-item"><a href="../Admin/adminCoupons.html" class="menu-link"><i class="fa-solid fa-tag"></i>
          &nbsp;Coupon Management</a></li>
      <li class="menu-item"><a href="../Admin/adminCategories.html" class="menu-link"><i
            class="fa-solid fa-layer-group"></i> &nbsp;Category Management</a></li>
      <li class="menu-item"><a href="../Admin/adminOffers.html" class="menu-link"><i class="fa-solid fa-gift"></i>
          &nbsp;Offer</a></li>
    </ul>

    <div class="admin-profile">
      <a href="../Admin/adminProfile.html" class="profile-info text-decoration-none text-reset">
        <img src="https://placehold.co/100x100/ccc/fff?text=A" alt="Admin" class="admin-avatar" />
        <div class="admin-details">
          <h6 id="sidebarName" class="m-0">Admin</h6>
          <span class="small text-muted">admin@example.com</span>
        </div>
      </a>
      <a href="./adminLogin.html" class="logout-btn">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> Logout
      </a>
    </div>
  </nav>

  <div class="main-content content-animate">
    <div class="page-header">
      <h2 class="page-title">Messages</h2>
    </div>

    <div class="toolbar-container">
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="msgSearch" placeholder="Search messages..." onkeyup="filterMessages()" />
      </div>
      <select class="filter-select" id="statusFilter" onchange="filterMessages()">
        <option value="all">All Messages</option>
        <option value="unread">Unread</option>
        <option value="read">Read</option>
        <option value="replied">Replied</option>
      </select>
    </div>

    <div class="message-list" id="messageListContainer"></div>
  </div>

  <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Message Details <span id="modalStatusBadge" class="ms-2 badge bg-secondary"
              style="font-size: 0.8rem; vertical-align: middle;"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex align-items-center mb-4">
            <div class="detail-avatar" id="modalAvatar"></div>
            <div>
              <h5 class="mb-0 fw-bold" id="modalSender"></h5>
              <span class="text-muted small" id="modalEmail"></span>
              <div class="text-muted" style="font-size: 0.75rem;" id="modalTime"></div>
            </div>
          </div>
          <h6 class="fw-bold fs-5" id="modalSubject"></h6>
          <div class="message-body-text mt-3" id="modalBody"></div>

          <!-- Existing Reply Display -->
          <div id="adminReplyDisplay" class="mt-4 p-3 bg-light border rounded d-none">
            <h6 class="fw-bold text-success"><i class="fa-solid fa-check-circle"></i> Repled:</h6>
            <p class="mb-0 text-muted" id="adminReplyText"></p>
            <small class="text-muted" id="adminReplyDate"></small>
          </div>

          <!-- New Reply Input Section -->
          <div id="replyInputSection" class="mt-4 d-none">
            <label class="form-label fw-bold">Your Reply:</label>
            <textarea class="form-control" id="replyMessage" rows="4" placeholder="Type your reply here..."></textarea>
            <div class="mt-2 text-end">
              <button class="btn btn-secondary btn-sm me-2" onclick="cancelReply()">Cancel</button>
              <button class="btn btn-primary btn-sm" onclick="sendReply()">Send Reply <i
                  class="fa-solid fa-paper-plane"></i></button>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <a href="#" id="replyBtn" class="btn btn-dark"><i class="fa-solid fa-reply"></i> Reply</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/adminBadge.js"></script>

  <script>
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
      document.getElementById("sidebarOverlay").classList.toggle("active");
    }

    let allMessages = [];

    async function fetchMessages() {
      try {
        console.log("Fetching messages from /api/admin/messages...");
        const response = await fetch("/api/admin/messages", {
          headers: {
            "Content-Type": "application/json"
            // Authorization header is not needed if using cookies
          },
          credentials: "include" // Ensure cookies are sent
        });

        if (response.status === 401) {
          console.warn("Unauthorized, redirecting to login...");
          window.location.href = "/Admin/adminLogin.html";
          return;
        }

        if (!response.ok) {
          const errText = await response.text();
          console.error("Fetch failed:", response.status, response.statusText, errText);
          throw new Error(`Failed to fetch messages: ${response.status} ${response.statusText}`);
        }

        allMessages = await response.json();
        console.log("Messages fetched:", allMessages);
        filterMessages();
      } catch (error) {
        console.error("Error fetching messages:", error);
        document.getElementById("messageListContainer").innerHTML =
          '<div class="p-4 text-center text-danger">Error loading messages. Check console for details.</div>';
      }
    }

    function renderMessages(data) {
      const container = document.getElementById("messageListContainer");
      container.innerHTML = data.length ? "" : '<div class="p-4 text-center text-muted">No messages found.</div>';

      data.forEach(msg => {
        let statusClass = '';
        let statusLabel = '';

        if (msg.status === 'unread' || (!msg.status && !msg.isRead)) {
          statusClass = 'unread';
          statusLabel = '<span class="badge bg-primary rounded-pill">Unread</span>';
        } else if (msg.status === 'replied') {
          statusClass = 'replied';
          statusLabel = '<span class="badge bg-success rounded-pill">Replied</span>';
        } else {
          statusLabel = '<span class="badge bg-secondary rounded-pill" style="opacity: 0.6;">Seen</span>';
        }

        const initials = getInitials(msg.name);
        const date = new Date(msg.createdAt).toLocaleDateString("en-US", {
          month: "short", day: "numeric", hour: "2-digit", minute: "2-digit"
        });

        container.innerHTML += `
            <div class="message-item ${statusClass}" onclick="viewMessage('${msg._id}')">
              <div class="msg-avatar">${initials}</div>
              <div class="msg-content">
                <div class="msg-header">
                  <span class="msg-sender">${msg.name} <span class="ms-2">${statusLabel}</span></span>
                  <span class="msg-time d-md-none">${date}</span>
                </div>
                <span class="msg-subject">${msg.subject}</span>
                <span class="msg-preview">${msg.message}</span>
              </div>
              <div class="text-end ps-2" style="min-width: 90px;">
                <div class="msg-time mb-2 d-none d-md-block">${date}</div>
                <div class="msg-actions justify-content-end" onclick="event.stopPropagation()">
                  <a href="#" class="action-icon" onclick="viewMessage('${msg._id}'); return false;"><i class="fa-regular fa-eye"></i></a>
                  <a href="#" class="action-icon delete" onclick="deleteMessage('${msg._id}', event); return false;"><i class="fa-regular fa-trash-can"></i></a>
                </div>
              </div>
            </div>`;
      });
    }

    async function deleteMessage(id, event) {
      if (event) event.stopPropagation();

      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`/api/admin/messages/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (response.ok) {
            Swal.fire('Deleted!', 'Message has been deleted.', 'success');
            // Remove from local array and re-render
            allMessages = allMessages.filter(m => m._id !== id);
            filterMessages();
            updateUnreadBadge();

            // If modal is open for this message, hide it
            if (messageModal && document.getElementById('modalSender').innerText) {
              // Check if the open message is indeed the deleted one (simple check via ID matching isn't direct here as modal doesn't store ID in text, but we can assume safe to close or just leave it if it's list action)
              // Actually, if we delete from list, modal might not be open.
              // If we add delete to modal later, we handle case.
            }
          } else {
            Swal.fire('Error!', 'Failed to delete message.', 'error');
          }
        } catch (error) {
          console.error(error);
          Swal.fire('Error!', 'Something went wrong.', 'error');
        }
      }
    }

    function getInitials(name) {
      return name
        .split(" ")
        .map((n) => n[0])
        .join("")
        .toUpperCase()
        .slice(0, 2);
    }

    function filterMessages() {
      const search = document.getElementById("msgSearch").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;

      const filtered = allMessages.filter(msg =>
        (msg.name.toLowerCase().includes(search) || msg.subject.toLowerCase().includes(search)) &&
        (
          status === 'all' ||
          (status === 'unread' && (msg.status === 'unread' || (!msg.status && !msg.isRead))) ||
          (status === 'read' && (msg.status === 'seen' || msg.status === 'replied' || msg.isRead)) ||
          (status === 'replied' && msg.status === 'replied')
        )
      );
      renderMessages(filtered);
    }

    // Initialize Modal instance once
    let messageModal;
    let pendingReplyUrl = null;
    let currentMessageId = null;

    document.addEventListener("DOMContentLoaded", () => {
      const modalEl = document.getElementById('messageModal');
      // Initialize bootstrap modal
      messageModal = new bootstrap.Modal(modalEl);

      // Listen for hidden event for accessibility-safe redirect
      // Listen for hidden event for accessibility-safe redirect
      // (Removed old mailto logic)
      modalEl.addEventListener('hidden.bs.modal', async () => {
        // Cleanup if needed
        currentMessageId = null;
      });

      fetchMessages();
    });

    async function viewMessage(id) {
      const msg = allMessages.find(m => m._id === id);
      if (msg) {
        currentMessageId = id;

        // Reset UI state
        document.getElementById('replyInputSection').classList.add('d-none');
        document.getElementById('replyMessage').value = '';

        // Mark as Seen logic (same as before)
        if (msg.status === 'unread' || (!msg.status && !msg.isRead)) {
          msg.status = 'seen';
          msg.isRead = true;
          filterMessages(); // Update list to show 'Seen'
          updateUnreadBadge();
          try {
            await fetch(`/api/admin/messages/${id}/seen`, { method: "PATCH", credentials: "include" });
          } catch (err) { console.error(err); }
        }

        // Populate Modal Details
        document.getElementById('modalAvatar').innerText = getInitials(msg.name);
        document.getElementById('modalSender').innerText = msg.name;
        document.getElementById('modalEmail').innerText = msg.email;
        document.getElementById('modalTime').innerText = new Date(msg.createdAt).toLocaleString();
        document.getElementById('modalSubject').innerText = msg.subject;
        document.getElementById('modalBody').innerText = msg.message;

        // Status Badge Logic
        const statusBadge = document.getElementById('modalStatusBadge');
        let statusLabel = '';
        if (msg.status === 'replied') {
          statusLabel = '<span class="badge bg-success rounded-pill">Replied</span>';
        } else {
          statusLabel = '<span class="badge bg-secondary rounded-pill">Seen</span>';
        }
        statusBadge.innerHTML = statusLabel;

        // Check for Existing Reply
        const replyDisplay = document.getElementById('adminReplyDisplay');
        const replyBtn = document.getElementById('replyBtn');

        if (msg.isReplied || msg.status === 'replied') {
          replyDisplay.classList.remove('d-none');
          document.getElementById('adminReplyText').innerText = msg.adminReply || '(No content)';
          document.getElementById('adminReplyDate').innerText = msg.repliedAt ? new Date(msg.repliedAt).toLocaleString() : '';

          replyBtn.classList.add('d-none'); // Hide reply button if already replied
        } else {
          replyDisplay.classList.add('d-none');
          replyBtn.classList.remove('d-none');
          replyBtn.onclick = () => startReply(); // Use internal function
          replyBtn.innerHTML = '<i class="fa-solid fa-reply"></i> Reply';
        }

        messageModal.show();
      }
    }

    function startReply() {
      document.getElementById('replyInputSection').classList.remove('d-none');
      document.getElementById('replyBtn').classList.add('d-none');
      document.getElementById('replyMessage').focus();
    }

    function cancelReply() {
      document.getElementById('replyInputSection').classList.add('d-none');
      document.getElementById('replyBtn').classList.remove('d-none');
    }

    async function sendReply() {
      const replyText = document.getElementById('replyMessage').value.trim();
      if (!replyText) {
        Swal.fire('Error', 'Reply cannot be empty', 'warning');
        return;
      }

      // Confirmation
      const result = await Swal.fire({
        title: 'Send Reply?',
        text: "This will send an email to the user.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Send',
        confirmButtonColor: '#0d6efd'
      });

      if (result.isConfirmed) {
        try {
          // Show Loading
          Swal.fire({ title: 'Sending...', didOpen: () => Swal.showLoading() });

          const response = await fetch(`/api/admin/messages/${currentMessageId}/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ reply: replyText })
          });

          const data = await response.json();

          if (response.ok) {
            Swal.fire('Sent!', 'Reply sent successfully.', 'success');

            // Update Local Data
            const m = allMessages.find(msg => msg._id === currentMessageId);
            if (m) {
              m.status = 'replied';
              m.isReplied = true;
              m.adminReply = replyText;
              m.repliedAt = new Date().toISOString();
            }

            // Refresh UI
            filterMessages();
            messageModal.hide(); // Close modal on success
          } else {
            Swal.fire('Error', data.error || 'Failed to send reply', 'error');
          }
        } catch (error) {
          console.error(error);
          Swal.fire('Error', 'Network error occurred', 'error');
        }
      }
    }
  </script>
</body>

</html>